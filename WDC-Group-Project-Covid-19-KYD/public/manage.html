<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- initialisation -->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- title of app -->
    <title>Keep Your Distance</title>

    <!-- bootstrap4 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous"/>

    <!-- w3school stylesheet -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="stylesheets/manage.css" />
    <link rel="javascript" href="javascripts/manage.js"/>
  </head>

  <!-- body -->
  <body class="background" onload="CheckId()">

    <!--logo & button style -->
    <div class="w3-bar w3-red w3-card w3-left-align w3-large">
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-red" href="javascript:void(0);" onclick="miniMenu()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>

      <!--logo-->
      <img class="w3-bar-item logo" src="images/wdc-project-logo.png" alt="KYD Logo">

      <!--buttons-->
      <div>
      <a href="kyd.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="Kyd">Home</a>
      <a href="/check-in-history.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="checkInHistory">Check-in-History</a>
      <a href="/venManage.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="venueInfo">Venue information</a>
      <a href="/manage.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-white" id="manages">Manage</a>
      <a href="/account.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="account">Account</a>
      <a href="/healthSignUp.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="healthSignUp">Sign-up</a>
      <a href="/login.html" class="button-resize w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" onclick="logout()">Log Out</a>
    </div>

    <!-- Navbar on small screens -->
      <div id="miniMenu" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
        <a href="/kyd.html" class="w3-bar-item w3-button w3-padding-large" id="Kyd2">Home</a>
        <a href="/check-in-history.html" class="w3-bar-item w3-button w3-padding-large" id="checkInHistory2">Check-In History</a>
        <a href="/venManage.html" class="w3-bar-item w3-button w3-padding-large" id="venueInfo2">Venue Information</a>
        <a href="/manage.html" class="w3-bar-item w3-button w3-padding-large" id="manage2">Manage</a>
        <a href="/account.html" class="w3-bar-item w3-button w3-padding-large" id="account2">Account</a>
        <a href="/healthSignUp.html" class="w3-bar-item w3-button w3-padding-large" id="healthSignUp2">Sign-up</a>
        <a href="/login.html" class="w3-bar-item w3-button w3-padding-large" onclick="logout()">Log Out</a>
      </div>
    </div>

    <!-- Search title -->
    <h2 id="title" style="text-decoration: underline">Search</h2>

    <div id="search">
      <input id="text-input" type="text" placeholder="Search via ID">
      <button id="search-button" onclick="IDSearch()">Search</button>
    </div>

    <!-- Div to contain management and check-in history section -->
    <div id="mainContent">
      <!-- User/Venue detail management section -->
      <div id="manage">
        <h3 style="text-decoration: underline">Update Information:</h3>
        <br>

        <!--USER STUFF-->
        <!-- Input for first Name -->
        <label for="firstName">User/Venue Name:</label>
        <br>
        <input type="text" id="firstName" class="form-control" name="firstName" placeholder="Eg: Lachlan">
        <br>
        <!-- Input for last name -->
        <label for="lastName">User/Venue Name:</label>
        <br>
        <input type="text" id="lastName" class="form-control" name="lastName" placeholder="Eg: Smith">
        <br>
        <!-- Input for Phone Number (both user) -->
        <label for="phoneNumber">Phone Number:</label>
        <br>
        <input type="text" id="phoneNumber" class="form-control" name="phoneNumber" placeholder="Eg: 0412345678">
        <br>
        <!-- Input for Email (both user) -->
        <label for="email">Email:</label>
        <br>
        <input type="text" id="email" class="form-control" name="email" placeholder="Eg: example@example.com">
        <br>
        <!-- Input for Email (both user) -->
        <label for="password">Password:</label>
        <br>
        <input type="text" id="password" class="form-control" name="password">
        <br>
        <!-- Input for User/Venue ID -->
        <!--<label for="ID">User/Venue ID:</label>-->
        <!--<br>-->
        <!--<input type="text" id="VenueID" class="form-control" name="VenueID" placeholder="Eg: U123456">-->
        <!--<br>-->

        <!--VENUE STUFF-->
        <div id="venueFields">
          <h4 style="text-decoration: underline">Venue Details:</h4>
          <!-- Input for Location (venue user only) -->
          <label for="venueName">Venue Name:</label>
          <br>
          <input type="text" id="venueName" class="form-control" name="venueName" placeholder="Eg: Nice Cafe">
          <br>
          <!-- Input for Location (venue user only) -->
          <label for="location">Address:</label>
          <br>
          <input type="text" id="location" class="form-control" name="location" placeholder="Eg: 46 Pennington Terrace, Adelaide, 5006">
          <br>
          <!-- Input for Capacity (venue user only) -->
          <label for="capacity">Capacity:</label>
          <br>
          <input type="text" id="capacity" class="form-control" name="capacity" placeholder="Eg: 42">
          <br>
        </div>

        <!--<input type="submit" class="btn btn-primary centerButton" value="Update Information">-->
        <button class="btn btn-primary centerButton" onclick="userAccountUpdate()">Update Information</button>
      </div>

      <div id="tablePlaceholder"></div>

      <!-- User Check-in history -->
      <div id="userCheckIn">
        <table class="table table-striped table-bordered">
          <thead>
            <!-- Column headings -->
            <tr>
              <th scope="col">#</th>
              <th scope="col">Time/Data</th>
              <th scope="col">Location</th>
              <th scope="col">Is it a HotSpot?</th>
            </tr>
          </thead>
          <tbody  id="userTable">
            <!-- Rows, will be populated with data from database -->

          </tbody>
        </table>
      </div>

      <!-- Venue Check-in history -->
      <div id="venueCheckIn">
        <table class="table table-striped table-bordered">
          <thead>
            <!--Column headings-->
            <tr>
              <th scope="col">ID</th>
              <th scope="col">First</th>
              <th scope="col">Last</th>
              <th scope="col">Time</th>
            </tr>
          </thead>
          <tbody  id="venueTable">
            <!--Rows, will be populated with data from database-->

          </tbody>
        </table>
      </div>
    </div>

    <!-- footer -->
    <footer>
      <div class="about_us">
      <ul>
        <LI>ABOUT US</LI>
        <li>
        <p>
            Aninda Lachlan Frank Thomas
        </p>
        </li>
        </ul>
        </div>

      <div class="link_ref">

        <a class="links" target="_blank"
        href="https://www.sahealth.sa.gov.au/wps/wcm/connect/public+content/sa+health+internet/conditions/infectious+diseases/covid-19/testing+and+tracing/contact+tracing/contact+tracing%22%3E">
          Visit SA Health for more information
        </a>
        </div>
        <div class="link_ref">
        <a class="links" target="_blank" href="mailto:aninda400@gmail.com">
           Queries? Contact us
          </a>
      </div>
    </footer>

    <script>

      // Used to toggle the menu on small screens when clicking on the menu button
      function miniMenu() {
        var x = document.getElementById("miniMenu");
        if (x.className.indexOf("w3-show") == -1) {
          x.className += " w3-show";
        } else {
          x.className = x.className.replace(" w3-show", "");
        }
      }


      function CheckId(){
          var xhttp = new XMLHttpRequest();

          xhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                var data = JSON.parse(this.responseText);
                var ID = data.ID;

                if(ID.includes("u")){
                  console.log("check u");
                  var x = document.getElementById("venueInfo");
                  x.style.display = "none";
                  x = document.getElementById("manages");
                  x.style.display = "none";
                  x = document.getElementById("healthSignUp");
                  x.style.display = "none";
                  x = document.getElementById("venueInfo2");
                  x.style.display = "none";
                  x = document.getElementById("manage2");
                  x.style.display = "none";
                  x = document.getElementById("healthSignUp2");
                  x.style.display = "none";
                }
                else if(ID.includes("h")){
                  console.log("check h");
                  var t = document.getElementById("venueInfo");
                  t.style.display = "none";
                  t = document.getElementById("checkInHistory");
                  t.style.display = "none";
                  t = document.getElementById("venueInfo2");
                  t.style.display = "none";
                  t = document.getElementById("checkInHistory2");
                  t.style.display = "none";

                }
                else if(ID.includes("v")){
                  console.log("check v");
                  var k = document.getElementById("manages");
                  k.style.display = "none";
                  k = document.getElementById("checkInHistory");
                  k.style.display = "none";
                  k = document.getElementById("healthSignUp");
                  k.style.display = "none";
                  k = document.getElementById("manage2");
                  k.style.display = "none";
                  k = document.getElementById("checkInHistory2");
                  k.style.display = "none";
                  k = document.getElementById("healthSignUp2");
                  k.style.display = "none";
                }
              else{
                alert("Your ID has no set user type!!!!");
              }
            }
            else if(this.readyState == 4 && this.status >= 400){
              alert("failed");
            }
          };

          xhttp.open("GET", "/GettingId", true);
          // xhttp.setRequestHeader("Content-type", "application/json");
          //Send JSON containing new account data.
          xhttp.send();
        }


        function IDSearch() {

          var searchID = document.getElementById("text-input").value;

          //Clear old user searches.
          var uTable = document.getElementById("userTable");
          while(uTable.firstChild) {
            uTable.removeChild(uTable.firstChild);
          }
          //Clear old venue searches.
          var vTable = document.getElementById("venueTable");
          while(vTable.firstChild) {
            vTable.removeChild(vTable.firstChild);
          }

          //If the specified ID is for a user, hide the venue specific elements.
          if(searchID.includes("u"))
          {
            //Set display properties to only show the user table.
            document.getElementById("tablePlaceholder").style.display = "none";
            document.getElementById("venueCheckIn").style.display = "none";
            document.getElementById("venueFields").style.display = "none";
            document.getElementById("userCheckIn").style.display = "block";

            //Fill check-in history.
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
              if(this.readyState == 4 && this.status == 200) {

                //Store JSON response.
                var data = JSON.parse(this.responseText);

                //Itterate over each check in item returned, create and append required objects.
                var i;
                for(i=0; i<data.length; i++)
                {
                    //Create Elements.
                    var row = document.createElement('tr');
                    var col1 = document.createElement('th');
                    var col2 = document.createElement('td');
                    var col3 = document.createElement('td');
                    var col4 = document.createElement('td');

                    //Insert data
                    col1.innerText = i+1;
                    col2.innerText = data[i].time;
                    col3.innerText = data[i].venueName;
                    //Hotspot text and color.
                    if(data[i].isHotspot == 0)
                    {
                      col4.innerText = "No";
                      col4.className = "No";
                    }
                    else if(data[i].isHotspot == 1)
                    {
                      col4.innerText = "Yes";
                      col4.className = "Yes";
                    }

                    //Append columns to row.
                    row.appendChild(col1);
                    row.appendChild(col2);
                    row.appendChild(col3);
                    row.appendChild(col4);
                    //Append row to tableBody.
                    document.getElementById("userTable").appendChild(row);
                }
              }
            };
            xhttp.open("POST", "/getCheckInData2", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send(JSON.stringify({ searchID: searchID }));

          }
          //If the ID is for a venue, hide the user specific elements.
          else if(searchID.includes("v"))
          {
            //Set display properties to only show the venue table.
            document.getElementById("venueFields").style.display = "block";
            document.getElementById("tablePlaceholder").style.display = "none";
            document.getElementById("userCheckIn").style.display = "none";
            document.getElementById("venueCheckIn").style.display = "block";

            var xhttp2 = new XMLHttpRequest();
            xhttp2.onreadystatechange = function() {
              if(this.readyState == 4 && this.status == 200) {
                //Store JSON response.
                var data = JSON.parse(this.responseText);

                //Itterate over each check in item returned, create and append required objects.
                var i;
                for(i=0; i<data.length; i++)
                {
                    //Create Elements.
                    var row = document.createElement('tr');
                    var col1 = document.createElement('td');
                    var col2 = document.createElement('td');
                    var col3 = document.createElement('td');
                    var col4 = document.createElement('td');

                    //Insert data
                    col1.innerText = data[i].userID;
                    col2.innerText = data[i].firstName;
                    col3.innerText = data[i].lastName;
                    col4.innerText = data[i].time;

                    //Append columns to row.
                    row.appendChild(col1);
                    row.appendChild(col2);
                    row.appendChild(col3);
                    row.appendChild(col4);

                    //Append row to tableBody.
                    document.getElementById("venueTable").appendChild(row);
                }
              }
            };
            xhttp2.open("POST", "/getVenueCheckIns2", true);
            xhttp2.setRequestHeader("Content-type", "application/json");
            xhttp2.send(JSON.stringify({ searchID: searchID }));
          }
          //No valid user was searched, hide table stuff.
          else
          {
            //Set display properties to only show the venue table.
            document.getElementById("venueFields").style.display = "block";
            document.getElementById("tablePlaceholder").style.display = "block";
            document.getElementById("userCheckIn").style.display = "none";
            document.getElementById("venueCheckIn").style.display = "none";
          }
        }


        function userAccountUpdate() {

          var searchID = document.getElementById("text-input").value;

          if(searchID.includes("u"))
          {
            //Check if any input was provided.
            if(document.getElementById("firstName").value.length == 0 && document.getElementById("lastName").value.length == 0
               && document.getElementById("phoneNumber").value.length == 0 && document.getElementById("email").value.length == 0 && document.getElementById("password").value.length == 0)
            {
              alert("No data provided!");
              return;
            }

            //Get values from input fields, set to NULL if no value provided.
            var userFirstName, userLastName, userPhoneNumber, userEmail, userPassword;

            userFirstName = document.getElementById("firstName").value;
            userLastName = document.getElementById("lastName").value;
            userPhoneNumber = document.getElementById("phoneNumber").value;
            userEmail = document.getElementById("email").value;
            userPassword = document.getElementById("password").value;

            if(document.getElementById("firstName").value.length == 0)
            {
              userFirstName = 'NULL';
            }
            if(document.getElementById("lastName").value.length == 0)
            {
              userLastName = 'NULL';
            }
            if(document.getElementById("phoneNumber").value.length == 0)
            {
              userPhoneNumber = 'NULL';
            }
            if(document.getElementById("email").value.length == 0)
            {
              userEmail = 'NULL';
            }
            if(document.getElementById("password").value.length == 0)
            {
              userPassword = 'NULL';
            }

            var userAccountData = {
              searchID: searchID,
              firstName: userFirstName,
              lastName: userLastName,
              phoneNumber: userPhoneNumber,
              email: userEmail,
              password: userPassword
            };

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
              if(this.readyState == 4 && this.status == 200) {
                alert("Succesfully updated account information for user " + searchID + ".");
                location.reload();
              }
            };
            xhttp.open("POST", "/updateAccountInfo2", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send(JSON.stringify(userAccountData));
          }
          else if(searchID.includes("v"))
          {
            //Check if any input was provided.
            if(document.getElementById("firstName").value.length == 0 && document.getElementById("lastName").value.length == 0
               && document.getElementById("phoneNumber").value.length == 0 && document.getElementById("email").value.length == 0
               && document.getElementById("password").value.length == 0 && document.getElementById("venueName").value.length == 0
               && document.getElementById("capacity").value.length == 0 && document.getElementById("location").value.length == 0)
            {
              alert("No data provided!");
              return;
            }

            //Get values from input fields, set to NULL if no value provided.
            var venueFirstName, venueLastName, venuePhoneNumber, venueEmail, venuePassword, venueVenueName, venueCapacity, venueLocation;

            venueFirstName = document.getElementById("firstName").value;
            venueLastName = document.getElementById("lastName").value;
            venuePhoneNumber = document.getElementById("phoneNumber").value;
            venueEmail = document.getElementById("email").value;
            venuePassword = document.getElementById("password").value;
            venueVenueName = document.getElementById("venueName").value;
            venueCapacity = document.getElementById("capacity").value;
            venueLocation = document.getElementById("location").value;

            if(document.getElementById("firstName").value.length == 0)
            {
              venueFirstName = 'NULL';
            }
            if(document.getElementById("lastName").value.length == 0)
            {
              venueLastName = 'NULL';
            }
            if(document.getElementById("phoneNumber").value.length == 0)
            {
              venuePhoneNumber = 'NULL';
            }
            if(document.getElementById("email").value.length == 0)
            {
              venueEmail = 'NULL';
            }
            if(document.getElementById("password").value.length == 0)
            {
              venuePassword = 'NULL';
            }
            if(document.getElementById("venueName").value.length == 0)
            {
              venueVenueName = 'NULL';
            }
            if(document.getElementById("capacity").value.length == 0)
            {
              venueCapacity = 'NULL';
            }
            if(document.getElementById("location").value.length == 0)
            {
              venueLocation = 'NULL';
            }

            var venueAccountData = {
              searchID: searchID,
              firstName: venueFirstName,
              lastName: venueLastName,
              phoneNumber: venuePhoneNumber,
              email: venueEmail,
              password: venuePassword,
              venueName: venueVenueName,
              capacity: venueCapacity,
              venueLocation: venueLocation
            };

            var xhttp2 = new XMLHttpRequest();
            xhttp2.onreadystatechange = function() {
              if(this.readyState == 4 && this.status == 200) {
                alert("Succesfully updated account information for venue " + searchID + ".");
                location.reload();
              }
            };
            xhttp2.open("POST", "/updateAccountInfo2", true);
            xhttp2.setRequestHeader("Content-type", "application/json");
            xhttp2.send(JSON.stringify(venueAccountData));
          }
          else
          {
            alert("Invalid user ID");
          }
        }


        function logout(){

          // Create AJAX Request
          var xmlhttp = new XMLHttpRequest();
          xmlhttp.open("POST", "/logout", true);
          xmlhttp.send();
        }

    </script>

  </body>
</html>