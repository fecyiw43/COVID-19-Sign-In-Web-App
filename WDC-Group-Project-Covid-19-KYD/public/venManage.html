<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- initialisation -->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- title of app -->
    <title>Keep Your Distance</title>

    <!-- bootstrap4 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous"/>

    <!-- w3school stylesheet -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="stylesheets/venManage.css" />
  </head>


  <!-- body -->
  <body class="background" onload="CheckId();getVenueCheckIns();getVenueInfo()">

    <!--logo & button style -->
    <div class="w3-bar w3-red w3-card w3-left-align w3-large">
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-red" href="javascript:void(0);" onclick="miniMenu()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>

      <!--logo-->
      <img class="w3-bar-item logo" src="images/wdc-project-logo.png" alt="KYD Logo">

      <!--buttons-->
      <div>
      <a href="kyd.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="Kyd">Home</a>
      <a href="/check-in-history.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="checkInHistory">Check-in-History</a>
      <a href="/venManage.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-white" id="venueInfo">Venue information</a>
      <a href="/manage.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="manages">Manage</a>
      <a href="/account.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="account">Account</a>
      <a href="/healthSignUp.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" id="healthSignUp">Sign-up</a>
      <a href="/login.html" class="button-resize w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white" onclick="logout()">Log Out</a>
    </div>

      <!-- Navbar on small screens -->
    <div id="miniMenu" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
      <a href="/kyd.html" class="w3-bar-item w3-button w3-padding-large" id="Kyd2">Home</a>
      <a href="/check-in-history.html" class="w3-bar-item w3-button w3-padding-large" id="checkInHistory2">Check-In History</a>
      <a href="/venManage.html" class="w3-bar-item w3-button w3-padding-large" id="venueInfo2">Venue Information</a>
      <a href="/manage.html" class="w3-bar-item w3-button w3-padding-large" id="manages2">Manage</a>
      <a href="/account.html" class="w3-bar-item w3-button w3-padding-large" id="account2">Account</a>
      <a href="/healthSignUp.html" class="w3-bar-item w3-button w3-padding-large" id="healthSignUp2">Sign-up</a>
       <a href="/login.html" class="w3-bar-item w3-button w3-padding-large" onclick="logout()">Log Out</a>
    </div>
    </div>

    <p id= "test">

    </p>

    <!-- Div to contain management and check-in history section -->
    <div id="mainContent">
      <!-- Venue detail management section -->
      <div id="manage">
          <h3 style="text-decoration: underline">Update Venue Information:</h3>
          <br>

          <!-- Display Venue details -->
          <strong>Venue ID:</strong>
          <p id="displayVenueCode"></p>
          <strong>Venue Name:</strong>
          <p id="displayVenueName"></p>
          <strong>Address:</strong>
          <p id="displayAddress"></p>
          <strong>Capacity</strong>
          <p id="displayCapacity"></p>

          <br>
          <!-- Input for Venue Name -->
          <label for="venueName">Venue Name:</label>
          <br>
          <input type="text" id="venueName" class="form-control" name="venueName" placeholder="Eg: Woodville Pizza Bar">
          <br><br>
          <!-- Input for Address -->
          <label for="location">Location:</label>
          <br>
          <input type="text" id="address" class="form-control" name="address" placeholder="Eg: 46 Pennington Terrace, Adelaide, 5006">
          <br><br>
          <!-- Input for Capacity -->
          <label for="capacity">Capacity:</label>
          <br>
          <input type="text" id="capacity" class="form-control" name="capacity" placeholder="Eg: 42">
          <br><br>
          <button class="btn btn-primary centerButton" onclick="updateVenueInfo()">Update Information</button>
      </div>

      <!-- Venue check in history -->
      <div id="checkIn">
        <table class="table table-striped table-bordered">
          <thead>
            <!-- Column headings -->
            <tr>
              <th scope="col">ID</th>
              <th scope="col">First</th>
              <th scope="col">Last</th>
              <th scope="col">Time</th>
            </tr>
          </thead>
          <!-- Rows, will be populated with data from database -->
          <tbody id="table">

          </tbody>
        </table>
      </div>

    </div>

    <!-- footer -->
    <footer>
      <div class="about_us">
      <ul>
        <LI>ABOUT US</LI>
        <li>
        <p>
            Aninda Lachlan Frank Thomas
        </p>
        </li>
        </ul>
        </div>

      <div class="link_ref">

        <a class="links" target="_blank"
        href="https://www.sahealth.sa.gov.au/wps/wcm/connect/public+content/sa+health+internet/conditions/infectious+diseases/covid-19/testing+and+tracing/contact+tracing/contact+tracing%22%3E">
          Visit SA Health for more information
        </a>
        </div>
        <div class="link_ref">
        <a class="links" target="_blank" href="mailto:aninda400@gmail.com">
           Queries? Contact us
          </a>
      </div>
    </footer>

    <script>
    // Used to toggle the menu on small screens when clicking on the menu button
    function miniMenu() {
      var x = document.getElementById("miniMenu");
      if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
      } else {
        x.className = x.className.replace(" w3-show", "");
      }
    }

    function CheckId(){
        var xhttp = new XMLHttpRequest();

        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              var data = JSON.parse(this.responseText);
              var ID = data.ID;

              if(ID.includes("u")){
                console.log("check u");
                var x = document.getElementById("venueInfo");
                x.style.display = "none";
                x = document.getElementById("manage");
                x.style.display = "none";
                x = document.getElementById("healthSignUp");
                x.style.display = "none";
                x = document.getElementById("venueInfo2");
                x.style.display = "none";
                x = document.getElementById("manages2");
                x.style.display = "none";
                x = document.getElementById("healthSignUp2");
                x.style.display = "none";
              }
              else if(ID.includes("h")){
                console.log("check h");
                var t = document.getElementById("venueInfo");
                t.style.display = "none";
                t = document.getElementById("checkInHistory");
                t.style.display = "none";
                t = document.getElementById("venueInfo2");
                t.style.display = "none";
                t = document.getElementById("checkInHistory2");
                t.style.display = "none";

              }
              else if(ID.includes("v")){
                console.log("check v");
                var k = document.getElementById("manage");
                k.style.display = "none";
                k = document.getElementById("checkInHistory");
                k.style.display = "none";
                k = document.getElementById("healthSignUp");
                k.style.display = "none";
                k = document.getElementById("manages2");
                k.style.display = "none";
                k = document.getElementById("checkInHistory2");
                k.style.display = "none";
                k = document.getElementById("healthSignUp2");
                k.style.display = "none";
              }
            else{
              alert("Your ID has no set user type!!!!");
            }
          }
          else if(this.readyState == 4 && this.status >= 400){
            alert("failed");
          }
        };

        xhttp.open("GET", "/GettingId", true);
        // xhttp.setRequestHeader("Content-type", "application/json");
        //Send JSON containing new account data.
        xhttp.send();
      }

    </script>

    <script>

      // function addToCoord() {
      //   var address = document.getElementById("address").value;
      //   var xhttp = new XMLHttpRequest();
      //   xhttp.onreadystatechange = function() {
      //     if(this.readyState == 4 && this.status == 200) {
      //       var coords = JSON.parse(this.responseText);
      //       longitude = coords.longitude;
      //       latitude = coords.latitude;
      //       // console.log(longitude);
      //       // console.log(latitude);
      //     }
      //   };
      //   xhttp.open("POST", "/forward", true);
      //   xhttp.setRequestHeader("Content-type", "application/json");
      //   xhttp.send(JSON.stringify({ Address: address }));
      // }

      //Convert coordinates to an address.
      function coordToAdd() {
        //var latitude = -34.907537;
        //var longitude = 138.670678;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if(this.readyState == 4 && this.status == 200) {
            document.getElementById('test').innerHTML = this.responseText;
            console.log(this.responseText);
          }
        };
        xhttp.open("POST", "/reverse", true);
        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.send(JSON.stringify({ Longitude: longitude, Latitude: latitude }));
      }

      //Get and display the check-in's for the given venue.
      function getVenueCheckIns() {

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if(xhttp.readyState == 4 && xhttp.status == 200) {
            //Store JSON response.
            var data = JSON.parse(xhttp.responseText);

            //Itterate over each check in item returned, create and append required objects.
            var i;
            for(i=0; i<data.length; i++)
            {
                //Create Elements.
                var row = document.createElement('tr');
                var col1 = document.createElement('td');
                var col2 = document.createElement('td');
                var col3 = document.createElement('td');
                var col4 = document.createElement('td');

                //Insert data
                col1.innerText = data[i].userID;
                col2.innerText = data[i].firstName;
                col3.innerText = data[i].lastName;
                col4.innerText = data[i].time;

                //Append columns to row.
                row.appendChild(col1);
                row.appendChild(col2);
                row.appendChild(col3);
                row.appendChild(col4);

                //Append row to tableBody.
                document.getElementById("table").appendChild(row);
            }
          }
        };
        xhttp.open("GET", "/getVenueCheckIns", true);
        xhttp.send();
      }

      //Get and display venue info (address and capacity).
      function getVenueInfo() {

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if(this.readyState == 4 && this.status == 200) {
            var venueDetails = JSON.parse(this.responseText);
            console.log(venueDetails);

            document.getElementById("displayVenueCode").innerText = venueDetails.venueCode;
            document.getElementById("displayVenueName").innerText = venueDetails.venueName;
            document.getElementById("displayAddress").innerText = venueDetails.address;
            document.getElementById("displayCapacity").innerText = venueDetails.capacity;
          }
        };
        xhttp.open("GET", "/getVenueInfo", true);
        xhttp.send();

      }

      //Update the venue's information in the database, including adding an address and it's respective coordinates.
      function updateVenueInfo() {

        //Check if input provided.
        if(document.getElementById("venueName").value.length == 0 && document.getElementById("capacity").value.length == 0
           && document.getElementById("address").value.length == 0)
        {
          alert("No data provided!");
          return;
        }

        //Get values from input fields, set to NULL if no value provided.
        var newVenName, newCapacity, newAddress;
        var longitude, latitude;

        // console.log(longitude);
        // console.log(latitude);

        newVenName = document.getElementById("venueName").value;
        newCapacity = document.getElementById("capacity").value;
        newAddress = document.getElementById("address").value;

        if(document.getElementById("venueName").value.length == 0)
        {
            newVenName = 'NULL';
        }
        if(document.getElementById("capacity").value.length == 0)
        {
            newCapacity = 'NULL';
        }
        if(document.getElementById("address").value.length == 0)
        {
            newAddress = 'NULL';
        }

        //xhttp1 deals with converting the venue's address to coordinates, xhttp2 updates the database.
        var xhttp1 = new XMLHttpRequest();
        xhttp1.onreadystatechange = function() {
          if(this.readyState == 4 && this.status == 200) {
            var coords = JSON.parse(this.responseText);

            longitude = coords.longitude;
            latitude = coords.latitude;

            // console.log(longitude);
            // console.log(latitude);

            var newData = {
              venueName: newVenName,
              capacity: newCapacity,
              address: newAddress,
              longitude: longitude,
              latitude: latitude
            };

            // console.log(newData.longitude);
            // console.log(newData.latitude);

            var xhttp2 = new XMLHttpRequest();
            xhttp2.onreadystatechange = function() {
              if(this.readyState == 4 && this.status == 200) {
                alert("Successfully updated venue information.");
                location.reload();
              }
            };
            xhttp2.open("POST", "/updateVenueInfo", true);
            xhttp2.setRequestHeader("Content-type", "application/json");
            xhttp2.send(JSON.stringify(newData));
          }

        };
        xhttp1.open("POST", "/forward", true);
        xhttp1.setRequestHeader("Content-type", "application/json");
        xhttp1.send(JSON.stringify({ Address: newAddress }));

        // console.log(longitude);
        // console.log(latitude);

      }

      function logout(){

        // Create AJAX Request
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST", "/logout", true);
        xmlhttp.send();
      }

    </script>

  </body>
</html>